---
import { type CollectionEntry } from 'astro:content'
import type {
  InferGetStaticParamsType,
  InferGetStaticPropsType,
  Page
} from 'astro'
import { getAllPosts, getAllTags, getPostsByTag } from '@lib/astro'
import LayoutArchive from '@components/layouts/Archive.astro'

type Props = InferGetStaticPropsType<typeof getStaticPaths> & {
  page: Page<CollectionEntry<'photos'>>
}
type Params = InferGetStaticParamsType<typeof getStaticPaths>

export async function getStaticPaths() {
  const allPosts = await getAllPosts()
  const allUniqueTags = await getAllTags(allPosts)

  return allUniqueTags.map((tag) => {
    const filteredPosts = getPostsByTag(allPosts, tag.name)

    return {
      params: { tag: tag.name },
      props: { page: { data: [...filteredPosts] } }
    }
  })

  // return paginate(allData, { pageSize: 20 })
}

// All paginated data + posts are passed on the "page" prop
const { page } = Astro.props as Props
const { tag } = Astro.params as Params
---

<LayoutArchive title={`#${tag}`} pageTitle={`#${tag}`} page={page} />
